# ansible_install_docker
install docker + docker-compose for ubuntu, debian, centos and other linux distributions

# –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ Docker Compose

## –ü—Ä–æ–±–ª–µ–º–∞
–í –∏—Å—Ö–æ–¥–Ω–æ–º playbook –≤–µ—Ä—Å–∏—è docker-compose –±—ã–ª–∞ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–∞ (`v2.36.0`), —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π.

## –†–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å lookup (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
```yaml
vars:
  docker_compose_version: "{{ lookup('url', 'https://api.github.com/repos/docker/compose/releases/latest', split_lines=False) | from_json | json_query('tag_name') }}"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ–π –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ playbook
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Ansible

### –í–∞—Ä–∏–∞–Ω—Ç 2: URI –º–æ–¥—É–ª—å + –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
```yaml
- name: Get latest docker-compose version
  uri:
    url: https://api.github.com/repos/docker/compose/releases/latest
    method: GET
    return_content: yes
  register: docker_compose_latest

- name: Install docker-compose
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º {{ docker_compose_latest.json.tag_name }}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –∑–∞–ø—Ä–æ—Å–æ–º
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- –ß–∏—Ç–∞–µ–º—ã–π –∫–æ–¥

### –í–∞—Ä–∏–∞–Ω—Ç 3: Shell —Å curl –∏ jq
```bash
LATEST_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥—É–ª–µ–π Ansible
- –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ –≥–¥–µ –µ—Å—Ç—å curl

### –í–∞—Ä–∏–∞–Ω—Ç 4: get_url –º–æ–¥—É–ª—å (–°–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π)
```yaml
- name: Download docker-compose
  get_url:
    url: "https://github.com/docker/compose/releases/download/{{ compose_release.json.tag_name }}/docker-compose-{{ ansible_system }}-{{ ansible_architecture }}"
    dest: /usr/local/bin/docker-compose
    mode: '0755'
    force: yes
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
- –õ—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –í–∞—Ä–∏–∞–Ω—Ç 5: –ì–æ—Ç–æ–≤–∞—è —Ä–æ–ª—å
```bash
ansible-galaxy install geerlingguy.docker
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º
- –í–∫–ª—é—á–∞–µ—Ç –≤—Å–µ best practices
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ—Ç–æ–≤–æ–π —Ä–æ–ª–∏

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–æ–ª–∏ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π
ansible-galaxy install -r requirements.yml

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ playbook
- hosts: all
  roles:
    - geerlingguy.docker
  vars:
    docker_install_compose: true
    docker_compose_version: "latest"
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Docker –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
- **playbook.yml** - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Ubuntu, Debian, CentOS
- **playbook_universal.yml** - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤  
- **playbook_no_jmespath.yml** - –µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏

–í—Å–µ —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é docker-compose —á–µ—Ä–µ–∑ GitHub API –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ:
- **Ubuntu** (18.04, 20.04, 22.04, 24.04)
- **Debian** (bullseye, bookworm, sid)
- **CentOS** (7, 8, Stream)
- **Rocky Linux** (8, 9)
- **AlmaLinux** (8, 9)
- **RHEL** (7, 8, 9)
- **Fedora** (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏)

### üìÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ playbook —Ñ–∞–π–ª—ã:
- `playbook.yml` - –æ—Å–Ω–æ–≤–Ω–æ–π playbook —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Ubuntu, Debian –∏ CentOS
- `playbook_universal.yml` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π playbook —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤
- `playbook_alternative.yml` - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –î–ª—è Debian/Ubuntu/CentOS:
```bash
ansible-playbook -i inventory playbook.yml
```

### –î–ª—è –≤—Å–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤:
```bash
ansible-playbook -i inventory playbook_universal.yml
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –û–°

### Debian
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker –¥–ª—è Debian
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–¥–æ–≤—ã–µ –∏–º–µ–Ω–∞: bullseye, bookworm, sid
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã

### Ubuntu  
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker –¥–ª—è Ubuntu
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç LTS –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
- –°–æ–≤–º–µ—Å—Ç–∏–º —Å –≤—Å–µ–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞–º–∏

### CentOS/RHEL/Rocky/Alma
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker –¥–ª—è CentOS
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç YUM –∏ DNF –º–µ–Ω–µ–¥–∂–µ—Ä—ã –ø–∞–∫–µ—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: "You need to install jmespath prior to running json_query filter"

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ jmespath –Ω–∞ control node.

**–†–µ—à–µ–Ω–∏–µ 1 - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å jmespath:**
```bash
pip3 install jmespath
```

**–†–µ—à–µ–Ω–∏–µ 2 - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å playbook –±–µ–∑ jmespath:**
```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª—ã –±–µ–∑ lookup —Ñ–∏–ª—å—Ç—Ä–æ–≤
ansible-playbook -i inventory playbook_no_jmespath.yml
```

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- –ó–∞–º–µ–Ω–∏–ª–∏ `lookup('url', '...') | json_query('tag_name')` 
- –ù–∞ `uri` –º–æ–¥—É–ª—å + `{{ register_var.json.tag_name }}`

### –û—à–∏–±–∫–∞: "404 Not Found" –¥–ª—è Ubuntu —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ Debian

**–ü—Ä–æ–±–ª–µ–º–∞:** Playbook –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª Ubuntu —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –≤—Å–µ—Ö Debian-based —Å–∏—Å—Ç–µ–º.

**–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–¥–µ–ª–∏–ª–∏ –ª–æ–≥–∏–∫—É –¥–ª—è Ubuntu –∏ Debian:
- Ubuntu: `https://download.docker.com/linux/ubuntu/`
- Debian: `https://download.docker.com/linux/debian/`

### –û—à–∏–±–∫–∞: "NO_PUBKEY 7EA0A9C3F273FCD8" (GPG –∫–ª—é—á)

**–ü—Ä–æ–±–ª–µ–º–∞:** GPG –∫–ª—é—á Docker –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.

**–†–µ—à–µ–Ω–∏–µ 1 - –û—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
# –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
ansible-playbook -i inventory clean_docker.yml

# –ó–∞—Ç–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ
ansible-playbook -i inventory playbook.yml
```

**–†–µ—à–µ–Ω–∏–µ 2 - –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
# –ù–∞ —Ü–µ–ª–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
sudo rm -f /etc/apt/sources.list.d/docker.list
sudo rm -f /etc/apt/keyrings/docker.gpg
sudo rm -f /usr/share/keyrings/docker-archive-keyring.gpg
sudo apt update
```

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏:**
- –†–∞–∑–¥–µ–ª–∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è GPG –∫–ª—é—á–∞ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- –£–±—Ä–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ escape —Å–∏–º–≤–æ–ª—ã –≤ –∫–æ–º–∞–Ω–¥–∞—Ö  
- –î–æ–±–∞–≤–∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `lsb_release -cs` –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û—à–∏–±–∫–∞: "HTTPSConnection.__init__() got an unexpected keyword argument 'cert_file'"

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç –≤–µ—Ä—Å–∏–π Python SSL –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π Ansible.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏–∏ –∏ SSL –ø–æ–¥–¥–µ—Ä–∂–∫—É
ansible-playbook diagnose.yml
```

**–†–µ—à–µ–Ω–∏–µ 1 - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ playbook:**
```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –±–µ–∑ uri –º–æ–¥—É–ª—è
ansible-playbook -i ~/ansible/linux/hosts playbook_universal_fixed.yml
# –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π
ansible-playbook -i ~/ansible/linux/hosts playbook_universal.yml
```

**–†–µ—à–µ–Ω–∏–µ 2 - –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
```bash
# –û–±–Ω–æ–≤–∏—Ç—å urllib3 –∏ requests
pip3 install --upgrade urllib3 requests ansible

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Å—Ä–µ–¥—É
python3 -m venv ansible_env
source ansible_env/bin/activate
pip install ansible
```

**–†–µ—à–µ–Ω–∏–µ 3 - –û–±–æ–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É:**
- –ó–∞–º–µ–Ω–∏–ª–∏ `uri` –º–æ–¥—É–ª—å –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π `curl` –≤ shell –∫–æ–º–∞–Ω–¥–µ
- –î–æ–±–∞–≤–∏–ª–∏ —Ñ–æ–ª–±—ç–∫ –≤–µ—Ä—Å–∏—é docker-compose  
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `curl` + `grep` + `sed` –≤–º–µ—Å—Ç–æ JSON –ø–∞—Ä—Å–∏–Ω–≥–∞

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### Control Node (–º–∞—à–∏–Ω–∞ —Å Ansible):
- Ansible >= 2.9
- Python 3.6+
- pip3 (–¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ jmespath, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### Managed Nodes (—Ü–µ–ª–µ–≤—ã–µ —Å–µ—Ä–≤–µ—Ä—ã):
- SSH –¥–æ—Å—Ç—É–ø
- sudo –ø—Ä–∞–≤–∞
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –û–° (—Å–º. —Å–ø–∏—Å–æ–∫ –≤—ã—à–µ)

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

–î–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é **–í–∞—Ä–∏–∞–Ω—Ç 1** (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å lookup), —Ç–∞–∫ –∫–∞–∫ –æ–Ω:
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
- –ü—Ä–æ—Å—Ç –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ  
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π GitHub API
